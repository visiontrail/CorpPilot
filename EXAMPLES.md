# 📝 CorpPilot 使用示例

## 业务场景示例

### 场景 1: 月度差旅成本分析

**业务需求**
财务部门需要分析 2024 年 1 月的差旅成本，识别超支部门和项目。

**操作步骤**

1. **准备数据**
   - 从 HR 系统导出 `状态明细.xlsx`（包含当月考勤数据）
   - 从差旅系统导出机票、酒店、火车票数据
   - 合并到一个 Excel 文件，确保 Sheet 名称正确

2. **上传文件**
   ```
   访问: http://localhost:5173/upload
   上传: 2024年1月差旅数据.xlsx
   等待: 系统自动分析（约 10-30 秒）
   ```

3. **查看结果**
   - **总成本**: ¥256,000
   - **异常记录**: 15 条
     - 类型 A: 8 条（上班但有差旅消费）
     - 类型 B: 7 条（出差但无消费记录）
   - **Top 3 超支部门**:
     - 市场部: ¥85,000 (33%)
     - 研发部: ¥72,000 (28%)
     - 销售部: ¥65,000 (25%)

4. **导出报告**
   - 点击"导出分析结果"
   - 获得包含分析结果的完整 Excel 文件
   - 提交给领导审阅

---

### 场景 2: 项目成本归集

**业务需求**
项目经理需要知道"05010013 市场-整星"项目的差旅成本明细。

**Excel 数据示例**

**Sheet: "机票"**
| 差旅人员姓名 | 授信金额 | 项目 | 出发日期 |
|-------------|---------|------|---------|
| 张三 | 1500 | 05010013 市场-整星测试 | 2024-01-05 |
| 李四 | 1800 | 05010013 市场-整星测试 | 2024-01-12 |
| 王五 | 1200 | 05020001 研发-卫星系统 | 2024-01-08 |

**分析结果**

Dashboard 中的"项目成本排名"图表显示：

```
05010013 市场-整星测试
├─ 总成本: ¥12,500
├─ 记录数: 8 条
└─ 明细:
   ├─ 机票: ¥5,300
   ├─ 酒店: ¥4,800
   └─ 火车票: ¥2,400
```

**导出的分析结果 Sheet**

| 项目代码 | 项目名称 | 总成本 | 记录数 |
|---------|---------|--------|--------|
| 05010013 | 市场-整星测试 | 12500 | 8 |
| 05020001 | 研发-卫星系统 | 9800 | 6 |

---

### 场景 3: 交叉验证异常检测

**业务需求**
HR 部门需要核查考勤与差旅数据的一致性。

**异常案例**

#### 异常 A: 上班但有差旅消费

**数据对比**

| 姓名 | 日期 | 考勤状态 | 差旅记录 |
|------|------|---------|---------|
| 张三 | 2024-01-10 | 上班 | 有北京酒店消费 ¥600 |

**可能原因**
- 代订：为同事预订酒店
- 考勤错误：实际出差但未更新考勤
- 提前预订：为下次出差提前预订

**Dashboard 显示**

```
异常记录表格:
┌────────┬────────────┬──────────────┬────────────────┐
│ 姓名   │ 日期       │ 异常类型     │ 说明           │
├────────┼────────────┼──────────────┼────────────────┤
│ 张三   │ 2024-01-10 │ A (上班有差旅)│ 考勤显示上班，  │
│        │            │              │ 但有酒店消费    │
└────────┴────────────┴──────────────┴────────────────┘
```

#### 异常 B: 出差但无差旅消费

**数据对比**

| 姓名 | 日期 | 考勤状态 | 差旅记录 |
|------|------|---------|---------|
| 李四 | 2024-01-15 | 出差 | 无任何消费记录 |

**可能原因**
- 漏报：忘记提交差旅报销单
- 自费：个人支付未报销
- 本地出差：同城出差无住宿需求

---

### 场景 4: 预订行为优化分析

**业务需求**
差旅管理部门希望优化机票预订策略，降低成本。

**数据分析**

**提前预定天数与平均成本关系**

| 提前天数 | 平均成本 | 订单数 |
|---------|---------|--------|
| 0-3天   | ¥2,100  | 12     |
| 4-7天   | ¥1,650  | 25     |
| 8-14天  | ¥1,280  | 30     |
| 15+天   | ¥1,050  | 18     |

**Dashboard 可视化**

折线图显示：
- 提前 15+ 天预订，成本降低 **50%**
- 提前 7-14 天预订，性价比最高
- 临时预订（0-3天）成本最高

**优化建议**

```
1. 制定预订政策:
   - 强制提前 7 天预订
   - 临时预订需审批
   
2. 预期成本节省:
   - 当前平均: ¥1,600
   - 优化后平均: ¥1,200
   - 年节省: (1600-1200) × 300 = ¥120,000
```

---

### 场景 5: 部门差旅成本对比

**业务需求**
管理层需要了解各部门的差旅成本构成。

**Dashboard 图表解读**

#### 饼图: 部门成本分布

```
┌─────────────────────────────────┐
│   市场部 (33%)                  │
│   ┌───────────────────┐         │
│   │   研发部 (28%)    │         │
│   │   ┌─────────┐     │         │
│   │   │销售部(25%)│    │         │
│   │   └─────────┘     │         │
│   └───────────────────┘         │
└─────────────────────────────────┘
```

#### 堆叠柱状图: 差旅类型成本

```
市场部  ██████████ 机票 ████ 酒店 ██ 火车
研发部  ███████ 机票 █████ 酒店 ███ 火车
销售部  █████████ 机票 ███ 酒店 ████ 火车
```

**分析结论**

- 市场部机票占比最高（60%），建议优化航线选择
- 研发部酒店成本高（45%），可能存在长期驻场需求
- 销售部差旅频次高但单次成本低，符合预期

---

## API 调用示例

### 1. 上传文件

```bash
curl -X POST "http://localhost:8000/api/upload" \
  -H "accept: application/json" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@差旅数据.xlsx"
```

**响应**
```json
{
  "success": true,
  "message": "文件上传成功",
  "data": {
    "file_path": "./uploads/20240105_120000_差旅数据.xlsx",
    "file_name": "差旅数据.xlsx",
    "sheets": ["状态明细", "机票", "酒店", "火车票"],
    "upload_time": "20240105_120000"
  }
}
```

### 2. 分析数据

```bash
curl -X POST "http://localhost:8000/api/analyze?file_path=./uploads/20240105_120000_差旅数据.xlsx"
```

**响应**
```json
{
  "success": true,
  "message": "分析完成",
  "data": {
    "overview": {
      "total_cost": 256000.00,
      "total_projects": 15,
      "total_departments": 8,
      "total_anomalies": 15
    },
    "department_costs": [...],
    "project_costs": [...],
    "anomalies": [...]
  }
}
```

### 3. 导出结果

```bash
curl -X POST "http://localhost:8000/api/export?file_path=./uploads/20240105_120000_差旅数据.xlsx" \
  --output 分析结果.xlsx
```

---

## 前端组件使用示例

### 使用 API Service

```typescript
import { uploadFile, analyzeExcel } from '@/services/api'

// 上传文件
const handleUpload = async (file: File) => {
  try {
    const result = await uploadFile(file)
    if (result.success) {
      console.log('文件路径:', result.data.file_path)
      
      // 自动分析
      const analysis = await analyzeExcel(result.data.file_path)
      console.log('分析结果:', analysis.data)
    }
  } catch (error) {
    console.error('操作失败:', error)
  }
}
```

### 自定义 ECharts 图表

```typescript
import ReactECharts from 'echarts-for-react'

const MyChart = ({ data }) => {
  const option = {
    title: { text: '自定义图表' },
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: data.labels },
    yAxis: { type: 'value' },
    series: [{
      type: 'bar',
      data: data.values
    }]
  }
  
  return <ReactECharts option={option} style={{ height: 400 }} />
}
```

---

## 常见数据问题及解决方案

### 问题 1: Sheet 名称不匹配

**错误**
```
分析失败: 找不到 Sheet "状态明细"
```

**解决方案**
确保 Excel 文件包含以下 Sheet（区分大小写）：
- `状态明细`
- `机票`
- `酒店`
- `火车票`

### 问题 2: 字段缺失

**错误**
```
KeyError: '授信金额'
```

**解决方案**
检查 Sheet 中是否包含必需字段：
- 差旅 Sheet: `差旅人员姓名`, `授信金额`, `出发日期`
- 考勤 Sheet: `姓名`, `日期`, `当日状态判断`

### 问题 3: 日期格式错误

**错误**
```
分析结果中日期显示异常
```

**解决方案**
确保 Excel 中日期格式为标准格式：
- `2024-01-01` 或 `2024/01/01`
- 避免使用文本格式存储日期

---

## 最佳实践

### 1. 数据准备

✅ **推荐**
- 使用标准 Excel 模板
- 定期清理历史数据
- 保持字段命名一致

❌ **避免**
- 合并单元格
- 包含无关的 Sheet
- 使用特殊字符

### 2. 分析频率

- **日常使用**: 每周上传一次，跟踪趋势
- **月度分析**: 月末完整分析，生成报告
- **季度审查**: 对比多月数据，优化政策

### 3. 结果应用

1. **异常处理**: 逐条核查异常记录，更新考勤或差旅数据
2. **成本控制**: 针对超支部门制定控制措施
3. **政策优化**: 基于预订行为分析调整差旅政策

---

**更多示例和技术支持**: support@galaxyspace.ai


